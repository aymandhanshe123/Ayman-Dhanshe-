{% schema %}
{
  "name": "Custom Product Grid",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Featured Products"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Custom Product Grid",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<section class="custom-product-grid">
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 class="custom-grid-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="grid grid--uniform">
      {% for block in section.blocks %}
        {% assign product = all_products[block.settings.product] %}
        {% if product %}
          <div class="grid__item small--one-half medium-up--one-third">
            <div class="product-card">
              <a href="{{ product.url }}" class="product-card__image">
                <img 
                  src="{{ product.featured_image | img_url: '400x' }}" 
                  alt="{{ product.title | escape }}">
              </a>
              <div class="product-card__info">
                <h3>{{ product.title }}</h3>
                <p>{{ product.price | money }}</p>
                <button 
                  type="button" 
                  class="btn add-to-cart" 
                  data-variant="{{ product.variants.first.id }}">
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<style>
.custom-product-grid {
  margin: 40px 0;
}
.custom-grid-heading {
  text-align: center;
  margin-bottom: 20px;
}
.product-card {
  border: 1px solid #eee;
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  transition: box-shadow 0.2s ease;
}
.product-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.product-card img {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
}
.btn {
  background: #000;
  color: #fff;
  padding: 8px 14px;
  border: none;
  cursor: pointer;
  margin-top: 10px;
  border-radius: 4px;
  transition: background 0.2s ease;
}
.btn:hover {
  background: #444;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const buttons = document.querySelectorAll(".add-to-cart");

  buttons.forEach(btn => {
    btn.addEventListener("click", function() {
      const variantId = this.dataset.variant;

      fetch("/cart/add.js", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.title + " added to cart!");

        // Update cart count if element exists
        const cartCount = document.querySelector("#CartCount");
        if (cartCount) {
          fetch("/cart.js")
            .then(res => res.json())
            .then(cart => {
              cartCount.innerText = cart.item_count;
            });
        }
      })
      .catch(err => {
        console.error("Error adding to cart:", err);
        alert("Sorry, something went wrong.");
      });
    });
  });
});
</script>
